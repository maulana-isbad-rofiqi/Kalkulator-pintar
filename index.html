<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KALTAIN ‚Ä¢ Cloud System</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Orbitron:wght@500;700;900&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['Space Grotesk', 'monospace'],
            cyber: ['Orbitron', 'sans-serif'],
          },
          colors: {
            primary: "#a855f7", 
          }
        }
      }
    }
  </script>

  <style>
    /* --- Base Setup --- */
    body { background-color: #050505; color: #ffffff; overflow-x: hidden; }

    /* --- Animated Background --- */
    .bg-aurora {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.4), transparent 25%), 
                  radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.2), transparent 25%);
      z-index: -2; filter: blur(60px); animation: pulseBg 10s infinite alternate;
    }
    @keyframes pulseBg { 0% { opacity: 0.8; transform: scale(1); } 100% { opacity: 1; transform: scale(1.1); } }

    /* --- Components --- */
    .glass-panel {
      background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
    }
    .input-cyber {
      background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.3s ease;
    }
    .input-cyber:focus { border-color: #a855f7; outline: none; }
    
    .btn-primary {
      background: linear-gradient(90deg, #7c3aed, #db2777); border: none;
      transition: transform 0.2s;
    }
    .btn-primary:active { transform: scale(0.95); }

    /* --- Loader --- */
    .loader {
      width: 40px; height: 40px; border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: #a855f7; border-radius: 50%; animation: spin 1s linear infinite; margin: 10px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .hidden { display: none !important; }
  </style>
</head>
<body class="antialiased selection:bg-purple-500 selection:text-white">

  <div class="bg-aurora"></div>
  
  <div id="splash" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-700">
    <div class="text-center space-y-4">
        <h1 class="font-cyber text-5xl md:text-7xl font-black bg-clip-text text-transparent bg-gradient-to-r from-purple-400 via-pink-500 to-cyan-400 animate-pulse">
          KALTAIN
        </h1>
        <div class="loader"></div>
        <p class="text-gray-500 font-mono text-xs mt-4">Connecting to Cloud...</p>
    </div>
  </div>

  <div id="authContainer" class="fixed inset-0 z-50 flex items-center justify-center hidden px-4 bg-black/80 backdrop-blur-sm">
    <div class="glass-panel w-full max-w-md p-8 rounded-3xl fade-in text-center">
      <div class="mb-8">
        <h2 class="font-cyber text-3xl font-bold text-white mb-2">AKSES CLOUD</h2>
        <p class="text-gray-400 text-sm">Masukkan Email untuk sinkronisasi data</p>
      </div>
      
      <div class="space-y-5 text-left">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">Email Google</label>
          <input type="email" id="loginEmail" class="input-cyber w-full p-4 rounded-xl text-center text-lg font-mono" placeholder="contoh@gmail.com">
        </div>
        
        <button onclick="login()" class="w-full py-4 rounded-xl font-bold text-lg btn-primary text-white mt-4 shadow-lg">
           <i class="fas fa-satellite-dish mr-2"></i> MASUK & SINKRON
        </button>
        
        <p class="text-xs text-gray-600 text-center mt-4">
          *Data Anda akan tersimpan otomatis di Google Sheet.
        </p>
      </div>
    </div>
  </div>

  <div id="app" class="relative z-10 min-h-screen hidden pb-20">
    
    <nav class="glass-panel sticky top-0 z-40 border-b border-white/10 mb-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-20">
          <div class="flex items-center gap-3" onclick="show('menu')" style="cursor:pointer">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-cyber font-bold text-xl">K</div>
            <div class="flex flex-col justify-center">
                <span class="font-cyber text-xl font-bold tracking-wide text-white leading-none">KALTAIN</span>
                <span class="text-[10px] text-green-400 font-mono uppercase tracking-wider">‚óè Online Mode</span>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-right hidden md:block">
              <div class="text-xs text-gray-400 uppercase">Account</div>
              <div id="userDisplay" class="font-bold text-cyan-400 font-mono text-xs md:text-sm">User</div>
            </div>
            <button onclick="logout()" class="w-10 h-10 rounded-full bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition flex items-center justify-center">
              <i class="fas fa-power-off"></i>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4">

      <div id="menu" class="fade-in">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-5xl font-bold font-cyber mb-2">DASHBOARD</h2>
          <p class="text-gray-400">Pilih alat yang ingin Anda gunakan.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <button onclick="show('target')" class="glass-panel p-8 rounded-3xl text-center hover:bg-purple-900/20 transition group relative overflow-hidden">
            <i class="fas fa-bullseye text-4xl text-purple-400 mb-4 group-hover:scale-110 transition"></i>
            <h3 class="text-xl font-bold">Target Pintar</h3>
          </button>
          <button onclick="show('dompet')" class="glass-panel p-8 rounded-3xl text-center hover:bg-green-900/20 transition group relative overflow-hidden">
            <i class="fas fa-wallet text-4xl text-green-400 mb-4 group-hover:scale-110 transition"></i>
            <h3 class="text-xl font-bold">Dompet Cloud</h3>
          </button>
          <button onclick="show('calc')" class="glass-panel p-8 rounded-3xl text-center hover:bg-blue-900/20 transition group relative overflow-hidden">
            <i class="fas fa-calculator text-4xl text-blue-400 mb-4 group-hover:scale-110 transition"></i>
            <h3 class="text-xl font-bold">Kalkulator</h3>
          </button>
          <button onclick="show('datecalc')" class="glass-panel p-8 rounded-3xl text-center hover:bg-orange-900/20 transition group relative overflow-hidden">
            <i class="fas fa-calendar-alt text-4xl text-orange-400 mb-4 group-hover:scale-110 transition"></i>
            <h3 class="text-xl font-bold">Waktu</h3>
          </button>
          <button onclick="show('sultan')" class="col-span-1 md:col-span-2 lg:col-span-4 glass-panel p-8 rounded-3xl flex items-center justify-between bg-gradient-to-r from-yellow-900/20 to-orange-900/20 border-yellow-500/30">
             <div class="flex items-center gap-4">
               <div class="text-3xl">üëë</div>
               <div class="text-left font-bold text-yellow-400">SULTAN AREA</div>
             </div>
             <i class="fas fa-arrow-right text-yellow-500"></i>
          </button>
        </div>
      </div>

      <div id="target" class="hidden fade-in">
        <div class="flex items-center mb-8 gap-4">
          <button onclick="show('menu')" class="w-12 h-12 rounded-xl glass-panel flex items-center justify-center hover:bg-white/10"><i class="fas fa-arrow-left"></i></button>
          <h2 class="text-2xl font-bold font-cyber">Target Pintar</h2>
        </div>
        <div class="grid lg:grid-cols-3 gap-8">
          <div class="lg:col-span-1 space-y-4">
             <div class="glass-panel p-6 rounded-2xl">
               <div class="space-y-4">
                 <div class="grid grid-cols-2 gap-2">
                   <input type="number" id="jmlPeriode" placeholder="Durasi" class="input-cyber p-3 rounded-lg w-full">
                   <select id="unit" class="input-cyber p-3 rounded-lg w-full bg-black"><option>Bulan</option><option>Tahun</option></select>
                 </div>
                 <input type="number" id="tLaba" placeholder="Target Laba (Rp)" class="input-cyber p-3 rounded-lg w-full border-l-4 border-green-500">
                 <input type="number" id="hBeli" placeholder="Harga Modal" class="input-cyber p-3 rounded-lg w-full">
                 <input type="number" id="hJual" placeholder="Harga Jual" class="input-cyber p-3 rounded-lg w-full">
                 <input type="number" id="bVariabel" placeholder="Biaya Lain (Packing)" class="input-cyber p-3 rounded-lg w-full">
                 <input type="number" id="bOperasional" placeholder="Biaya Operasional" class="input-cyber p-3 rounded-lg w-full">
               </div>
               <button onclick="hitungTarget()" class="w-full mt-6 btn-primary py-4 rounded-xl font-bold text-lg shadow-lg">HITUNG</button>
             </div>
          </div>
          <div class="lg:col-span-2">
             <div id="hasilTarget" class="glass-panel h-full p-8 rounded-2xl flex flex-col items-center justify-center text-center border-dashed border-2 border-gray-700">
               <i class="fas fa-chart-pie text-6xl text-gray-700 mb-4"></i>
               <p class="text-gray-500">Hasil analisis akan muncul di sini.</p>
             </div>
          </div>
        </div>
      </div>

      <div id="dompet" class="hidden fade-in">
        <div class="flex items-center mb-8 gap-4">
          <button onclick="show('menu')" class="w-12 h-12 rounded-xl glass-panel flex items-center justify-center hover:bg-white/10"><i class="fas fa-arrow-left"></i></button>
          <div>
            <h2 class="text-2xl font-bold font-cyber">Dompet Cloud</h2>
            <p class="text-xs text-gray-400" id="statusSync">Menunggu sinkronisasi...</p>
          </div>
        </div>

        <div id="ringkasanDompet" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
           </div>

        <div class="grid md:grid-cols-2 gap-8">
          <div class="glass-panel p-6 rounded-2xl h-fit">
             <h3 class="font-bold mb-4">Transaksi Baru</h3>
             <div class="flex gap-4 mb-6">
               <button onclick="setTipe('pemasukan')" id="btnMasuk" class="flex-1 py-3 rounded-xl border border-green-500/30 text-green-400 hover:bg-green-500/20 transition">Masuk</button>
               <button onclick="setTipe('pengeluaran')" id="btnKeluar" class="flex-1 py-3 rounded-xl border border-red-500/30 text-red-400 hover:bg-red-500/20 transition">Keluar</button>
             </div>
             <div class="space-y-4">
                <input type="number" id="jumlahTransaksi" placeholder="Nominal (Rp)" class="input-cyber w-full p-4 rounded-xl text-xl font-mono">
                <input type="text" id="ketTransaksi" placeholder="Keterangan" class="input-cyber w-full p-4 rounded-xl">
                <button onclick="simpanTransaksi()" id="btnSimpan" class="w-full bg-white/10 py-4 rounded-xl font-bold flex justify-center items-center gap-2 hover:bg-white/20 transition">
                    <span>KIRIM KE CLOUD</span>
                </button>
             </div>
          </div>
          
          <div class="glass-panel p-6 rounded-2xl max-h-[600px] overflow-y-auto relative">
             <div class="flex justify-between items-center border-b border-white/10 pb-4 sticky top-0 bg-[#141419] z-10 mb-4">
                 <h3 class="font-bold">Riwayat Online</h3>
                 <button onclick="fetchDataCloud()" class="text-xs bg-purple-500/20 text-purple-400 px-3 py-1 rounded-lg hover:bg-purple-500/40">
                   <i class="fas fa-sync-alt mr-1"></i> Refresh
                 </button>
             </div>
             <div id="loadingList" class="hidden text-center py-10"><div class="loader w-8 h-8"></div></div>
             <div id="riwayatContainer" class="space-y-3"></div>
          </div>
        </div>
      </div>

      <div id="calc" class="hidden fade-in">
        <div class="flex items-center mb-6 gap-4">
          <button onclick="show('menu')" class="w-12 h-12 rounded-xl glass-panel flex items-center justify-center hover:bg-white/10"><i class="fas fa-arrow-left"></i></button>
          <h2 class="text-2xl font-bold font-cyber">Kalkulator</h2>
        </div>
        <div class="max-w-xs mx-auto glass-panel p-6 rounded-3xl">
          <input type="text" id="calcDisplay" readonly class="w-full bg-black/40 text-right text-3xl p-4 rounded-xl mb-4 font-mono text-cyan-400" value="0">
          <div class="grid grid-cols-4 gap-3">
            <button onclick="clearCalc()" class="p-4 rounded-xl bg-red-500/20 text-red-400">C</button>
            <button onclick="delCalc()" class="p-4 rounded-xl bg-gray-700/50">‚å´</button>
            <button onclick="inputCalc('/')" class="p-4 rounded-xl bg-purple-500/20 text-purple-400">√∑</button>
            <button onclick="inputCalc('*')" class="p-4 rounded-xl bg-purple-500/20 text-purple-400">√ó</button>
            <button onclick="inputCalc('7')" class="p-4 rounded-xl bg-white/5">7</button>
            <button onclick="inputCalc('8')" class="p-4 rounded-xl bg-white/5">8</button>
            <button onclick="inputCalc('9')" class="p-4 rounded-xl bg-white/5">9</button>
            <button onclick="inputCalc('-')" class="p-4 rounded-xl bg-purple-500/20 text-purple-400">‚àí</button>
            <button onclick="inputCalc('4')" class="p-4 rounded-xl bg-white/5">4</button>
            <button onclick="inputCalc('5')" class="p-4 rounded-xl bg-white/5">5</button>
            <button onclick="inputCalc('6')" class="p-4 rounded-xl bg-white/5">6</button>
            <button onclick="inputCalc('+')" class="p-4 rounded-xl bg-purple-500/20 text-purple-400">+</button>
            <button onclick="inputCalc('1')" class="p-4 rounded-xl bg-white/5">1</button>
            <button onclick="inputCalc('2')" class="p-4 rounded-xl bg-white/5">2</button>
            <button onclick="inputCalc('3')" class="p-4 rounded-xl bg-white/5">3</button>
            <button onclick="calcResult()" class="row-span-2 p-4 rounded-xl bg-blue-600 text-white">=</button>
            <button onclick="inputCalc('0')" class="col-span-2 p-4 rounded-xl bg-white/5">0</button>
            <button onclick="inputCalc('.')" class="p-4 rounded-xl bg-white/5">.</button>
          </div>
        </div>
      </div>

      <div id="datecalc" class="hidden fade-in">
        <div class="flex items-center mb-8 gap-4">
          <button onclick="show('menu')" class="w-12 h-12 rounded-xl glass-panel flex items-center justify-center hover:bg-white/10"><i class="fas fa-arrow-left"></i></button>
          <h2 class="text-2xl font-bold font-cyber">Kalkulator Waktu</h2>
        </div>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="glass-panel p-6 rounded-2xl">
             <h3 class="text-lg font-bold mb-4 text-blue-400">Selisih Hari</h3>
             <div class="space-y-4">
               <input type="date" id="date1" class="input-cyber w-full p-3 rounded-lg">
               <input type="date" id="date2" class="input-cyber w-full p-3 rounded-lg">
               <button onclick="hitungSelisih()" class="w-full btn-primary py-3 rounded-lg font-bold">HITUNG JARAK</button>
               <p id="hasilSelisih" class="text-center text-3xl font-black mt-4 text-white">-</p>
             </div>
          </div>
          <div class="glass-panel p-6 rounded-2xl">
             <h3 class="text-lg font-bold mb-4 text-orange-400">Prediksi Tanggal</h3>
             <div class="space-y-4">
               <input type="date" id="baseDate" class="input-cyber w-full p-3 rounded-lg">
               <input type="number" id="hariTambah" placeholder="Jumlah hari (+ atau -)" class="input-cyber w-full p-3 rounded-lg">
               <button onclick="tambahHari()" class="w-full btn-primary py-3 rounded-lg font-bold">HITUNG TANGGAL</button>
               <p id="hasilTanggal" class="text-center text-3xl font-black mt-4 text-white">-</p>
             </div>
          </div>
        </div>
      </div>

      <div id="sultan" class="hidden fade-in text-center py-10">
        <button onclick="show('menu')" class="mb-8 text-gray-400 hover:text-white flex items-center mx-auto gap-2"><i class="fas fa-arrow-left"></i> Kembali</button>
        <div class="inline-block p-1 rounded-3xl bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 shadow-xl">
          <div class="glass-panel p-10 rounded-[20px] max-w-md">
            <h2 class="text-4xl font-black font-cyber text-yellow-400 mb-6">SULTAN AREA</h2>
            <p class="mb-8 text-gray-300 leading-relaxed">Jika tools ini membantu bisnis Anda, traktir saya kopi! ‚òï</p>
            <div class="bg-white p-4 rounded-xl inline-block mb-8">
               <img src="https://i.postimg.cc/VNnw27W2/qris.png" alt="QRIS Donation" class="w-48 h-48 object-contain">
            </div>
            <div class="text-xs text-gray-500 uppercase tracking-widest">Developer by „ÄêÔªø ùïÄùï•ùï§ùïìùïíùïï „Äë</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // =========================================================
    // 1. KONFIGURASI SERVER (CLOUD)
    // =========================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbwBTo6kaeM3xA5OsVTPBS3k9qlSpb4xupJ5rc5ge9y9NgxQLFc8Gaz2moeZCbkcdsYg/exec";
    
    const STORAGE_EMAIL = 'kaltain_cloud_email';
    let currentUserEmail = null;
    let currentTransType = 'pengeluaran';
    let transactionData = []; // Menyimpan data dari cloud

    // --- STARTUP ---
    window.onload = () => {
      setTimeout(() => {
        document.getElementById('splash').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('splash').classList.add('hidden');
          checkSession();
        }, 700); 
      }, 2500); 
    };

    function checkSession() {
      const savedEmail = localStorage.getItem(STORAGE_EMAIL);
      if (savedEmail) {
        currentUserEmail = savedEmail;
        enterApp();
      } else {
        document.getElementById('authContainer').classList.remove('hidden');
      }
    }

    function enterApp() {
      document.getElementById('authContainer').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('userDisplay').textContent = currentUserEmail;
      show('menu');
      
      // Set default button state
      setTipe('pengeluaran');
    }

    // --- AUTH (EMAIL ONLY) ---
    function login() {
      const email = document.getElementById('loginEmail').value.trim();
      // Simple email validation
      if (!email || !email.includes('@')) return alert("Mohon masukkan email yang valid!");
      
      localStorage.setItem(STORAGE_EMAIL, email);
      currentUserEmail = email;
      enterApp();
    }

    function logout() {
      if(confirm('Keluar dari akun?')) {
        localStorage.removeItem(STORAGE_EMAIL);
        location.reload();
      }
    }

    // --- NAVIGATION ---
    function show(id) {
      const pages = ['menu', 'target', 'dompet', 'calc', 'datecalc', 'sultan'];
      pages.forEach(p => document.getElementById(p).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      window.scrollTo(0,0);
      
      if(id === 'dompet') {
        fetchDataCloud(); // Tarik data saat buka menu dompet
      }
    }

    function formatRupiah(num) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
    }

    // --- FEATURE: DOMPET (CLOUD INTEGRATION) ---
    
    // 1. Fetch Data (GET)
    async function fetchDataCloud() {
      const statusEl = document.getElementById('statusSync');
      const loader = document.getElementById('loadingList');
      const listContainer = document.getElementById('riwayatContainer');
      
      statusEl.textContent = "Sedang mengambil data...";
      statusEl.className = "text-xs text-yellow-400 animate-pulse";
      loader.classList.remove('hidden');
      listContainer.innerHTML = ""; // Clear list

      try {
        const response = await fetch(`${API_URL}?email=${currentUserEmail}`);
        const data = await response.json();
        
        // Data dari Google Sheet urutannya: Tgl, Email, Tipe, Jumlah, Ket
        // Kita mapping ke format objek agar mudah
        transactionData = data.reverse(); // Balik agar terbaru diatas
        
        renderDompet();
        statusEl.textContent = "Data tersinkronisasi";
        statusEl.className = "text-xs text-green-400";
      } catch (error) {
        console.error(error);
        statusEl.textContent = "Gagal koneksi internet";
        statusEl.className = "text-xs text-red-400";
        listContainer.innerHTML = `<div class="text-center text-gray-500 text-sm mt-4">Gagal memuat data. Cek sinyal.</div>`;
      } finally {
        loader.classList.add('hidden');
      }
    }

    // 2. Render UI
    function renderDompet() {
      const listContainer = document.getElementById('riwayatContainer');
      let saldo = 0, masuk = 0, keluar = 0;
      
      let html = '';
      
      if(transactionData.length === 0) {
        html = `<div class="text-center text-gray-500 text-sm mt-10">Belum ada transaksi.</div>`;
      } else {
        transactionData.forEach(t => {
          // t = { date, type, amount, desc } sesuai respon script
          const val = parseInt(t.amount);
          if(t.type === 'pemasukan') {
             saldo += val;
             masuk += val;
          } else {
             saldo -= val;
             keluar += val;
          }
          
          const color = t.type === 'pemasukan' ? 'text-green-400' : 'text-red-400';
          const sign = t.type === 'pemasukan' ? '+' : '-';
          const dateStr = new Date(t.date).toLocaleDateString('id-ID');
          
          html += `
            <div class="flex justify-between items-center p-3 glass-panel rounded-xl fade-in">
              <div>
                <div class="font-bold text-sm text-white">${t.desc}</div>
                <div class="text-xs text-gray-500">${dateStr}</div>
              </div>
              <div class="font-mono font-bold ${color}">${sign} ${val.toLocaleString()}</div>
            </div>
          `;
        });
      }
      
      listContainer.innerHTML = html;
      
      // Update Ringkasan
      document.getElementById('ringkasanDompet').innerHTML = `
        <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-purple-900/40 to-transparent">
          <div class="text-gray-400 text-sm mb-1">Saldo Cloud</div>
          <div class="text-3xl font-bold text-white break-words font-mono">${formatRupiah(saldo)}</div>
        </div>
        <div class="glass-panel p-6 rounded-2xl">
          <div class="text-gray-400 text-sm mb-1">Total Masuk</div>
          <div class="text-2xl font-bold text-green-400 break-words">+ ${formatRupiah(masuk)}</div>
        </div>
        <div class="glass-panel p-6 rounded-2xl">
          <div class="text-gray-400 text-sm mb-1">Total Keluar</div>
          <div class="text-2xl font-bold text-red-400 break-words">- ${formatRupiah(keluar)}</div>
        </div>
      `;
    }

    // 3. Kirim Data (POST)
    function setTipe(t) {
      currentTransType = t;
      const btnM = document.getElementById('btnMasuk');
      const btnK = document.getElementById('btnKeluar');
      
      // Reset css
      btnM.className = "flex-1 py-3 rounded-xl border border-green-500/30 text-green-400 transition opacity-50";
      btnK.className = "flex-1 py-3 rounded-xl border border-red-500/30 text-red-400 transition opacity-50";
      
      if(t === 'pemasukan') {
        btnM.classList.remove('opacity-50');
        btnM.classList.add('bg-green-500/20');
      } else {
        btnK.classList.remove('opacity-50');
        btnK.classList.add('bg-red-500/20');
      }
    }

    function simpanTransaksi() {
      const nominal = document.getElementById('jumlahTransaksi').value;
      const ket = document.getElementById('ketTransaksi').value;
      
      if(!nominal || nominal <= 0) return alert("Masukkan nominal!");
      
      const btn = document.getElementById('btnSimpan');
      const originalText = btn.innerHTML;
      
      // Loading state
      btn.innerHTML = `<div class="loader w-5 h-5 border-white/30 border-t-white m-0"></div> Mengirim...`;
      btn.disabled = true;
      
      const payload = {
        email: currentUserEmail,
        type: currentTransType,
        amount: nominal,
        desc: ket || "-"
      };
      
      // Kirim ke Google Script (Mode no-cors)
      fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(() => {
        // Karena no-cors tidak return response json, kita anggap sukses setelah fetch selesai
        document.getElementById('jumlahTransaksi').value = '';
        document.getElementById('ketTransaksi').value = '';
        
        // Refresh data setelah 1.5 detik (memberi waktu sheet update)
        setTimeout(() => {
             fetchDataCloud();
             btn.innerHTML = originalText;
             btn.disabled = false;
             alert("Data berhasil disimpan ke Cloud!");
        }, 1500);
        
      }).catch(err => {
        alert("Gagal mengirim data.");
        console.error(err);
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    }

    // --- FEATURE: CALCULATOR & TARGET (Offline Logic) ---
    
    // Target Pintar
    function hitungTarget() {
      const fields = ['jmlPeriode', 'hBeli', 'hJual', 'bVariabel', 'bOperasional', 'tLaba'];
      const vals = {};
      fields.forEach(f => vals[f] = parseFloat(document.getElementById(f).value) || 0);
      const unit = document.getElementById('unit').value;
      
      if(vals.hJual <= (vals.hBeli + vals.bVariabel)) return alert("Harga Jual terlalu rendah!");

      const hariTotal = unit === 'Bulan' ? vals.jmlPeriode * 30 : vals.jmlPeriode * 365;
      const margin = vals.hJual - vals.hBeli - vals.bVariabel;
      const fixedCostTotal = vals.bOperasional * (hariTotal/30);
      
      const targetUnit = Math.ceil((vals.tLaba + fixedCostTotal) / margin);
      const bepUnit = Math.ceil(fixedCostTotal / margin);
      const targetHarian = Math.ceil(targetUnit / hariTotal);

      document.getElementById('hasilTarget').innerHTML = `
        <div class="text-left w-full space-y-2">
          <h3 class="text-xl font-bold text-green-400 border-b border-white/10 pb-2">HASIL ANALISIS</h3>
          <div class="flex justify-between text-gray-300"><span>BEP (Unit):</span> <span class="font-bold text-yellow-400">${bepUnit.toLocaleString()}</span></div>
          <div class="flex justify-between text-gray-300"><span>Target Total:</span> <span class="font-bold text-purple-400">${targetUnit.toLocaleString()} Unit</span></div>
          <div class="flex justify-between text-white text-lg font-bold mt-2 pt-2 border-t border-dashed border-white/20">
            <span>Target/Hari:</span> <span>${targetHarian.toLocaleString()} Unit</span>
          </div>
        </div>
      `;
      document.getElementById('hasilTarget').classList.remove('border-dashed', 'text-center');
    }

    // Calculator Logic
    let calcStr = '';
    function inputCalc(v) { calcStr += v; document.getElementById('calcDisplay').value = calcStr; }
    function clearCalc() { calcStr = ''; document.getElementById('calcDisplay').value = '0'; }
    function delCalc() { calcStr = calcStr.slice(0, -1); document.getElementById('calcDisplay').value = calcStr || '0'; }
    function calcResult() {
      try {
        const safeStr = calcStr.replace(/[^0-9\+\-\*\/\.]/g, ''); 
        if(!safeStr) return;
        const res = Function('"use strict";return (' + safeStr + ')')();
        document.getElementById('calcDisplay').value = res;
        calcStr = String(res);
      } catch (e) {
        document.getElementById('calcDisplay').value = "Error";
        calcStr = '';
      }
    }
    
    // Date Calc Logic
    function hitungSelisih() {
      const d1 = new Date(document.getElementById('date1').value);
      const d2 = new Date(document.getElementById('date2').value);
      if(isNaN(d1) || isNaN(d2)) return alert("Pilih tanggal");
      const diff = Math.abs(d2 - d1);
      document.getElementById('hasilSelisih').textContent = Math.ceil(diff / (86400000)) + " Hari";
    }
    function tambahHari() {
      const base = new Date(document.getElementById('baseDate').value);
      const add = parseInt(document.getElementById('hariTambah').value) || 0;
      if(isNaN(base)) return alert("Pilih tanggal");
      base.setDate(base.getDate() + add);
      document.getElementById('hasilTanggal').textContent = base.toLocaleDateString('id-ID');
    }
  </script>
</body>
</html>
